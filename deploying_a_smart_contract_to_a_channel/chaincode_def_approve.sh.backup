#!/bin/bash

source common_export.sh

print_usage () {
	echo "Usage: chaincode_def_approve.sh [org1|org2]"
}

ORG_N=$1

if [ $# -eq 0 ]
then
	print_usage
	exit 1
fi

if [ "$ORG_N" = "org1" ]
then
	source org1_var_export.sh
elif [ "$ORG_N" = "org2" ]
then
	source org2_var_export.sh
else
	echo "$(date): ERROR: Please specify the target org"
	print_usage
	exit 1
fi

PACKAGE_ID=$(peer lifecycle chaincode queryinstalled | grep Package | awk -F 'Package ID: |, Label' '{print $2}')
ret=$?

if [ "$ret" -ne 0 ]
then
	echo "[ERROR]: $(date): FAILED to extract package ID"
	exit 1
else
	# Approve the chaincode definition
	export CC_PACKAGE_ID=$PACKAGE_ID
	if peer lifecycle chaincode approveformyorg -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --channelID mychannel --name basic --version 1.0 --package-id $CC_PACKAGE_ID --sequence 1 --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"
	then
		echo "$(date): SUCCESSFUL chaincode approval on $ORG_N"
	else
		echo "[ERROR]: $(date): FAILED chaincode approval on $ORG_N"
		exit 1
	fi
fi

exit
